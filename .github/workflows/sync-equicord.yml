name: ðŸ”„ Sync Equicord Updates

on:
    schedule:
        # VÃ©rifier tous les jours Ã  2h du matin UTC
        - cron: "0 2 * * *"
    workflow_dispatch:
        # Permettre le dÃ©clenchement manuel

jobs:
    sync-upstream:
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“¥ Checkout Bashcord
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: âš™ï¸ Configuration Git
              run: |
                  git config user.name "Bashcord Bot"
                  git config user.email "action@github.com"

            - name: ðŸ”— Ajouter remote upstream
              run: |
                  git remote add upstream https://github.com/Equicord/Equicord.git || true

            - name: ðŸ“¥ Fetch upstream
              run: |
                  git fetch upstream

            - name: ðŸ” VÃ©rifier les nouvelles modifications
              id: check-updates
              run: |
                  if [ "$(git rev-list --count HEAD..upstream/main)" -gt 0 ]; then
                    echo "updates=true" >> $GITHUB_OUTPUT
                    echo "ðŸ†• Nouvelles modifications dÃ©tectÃ©es!"
                  else
                    echo "updates=false" >> $GITHUB_OUTPUT
                    echo "âœ… Bashcord est Ã  jour"
                  fi

            - name: ðŸ›¡ï¸ Restaurer protection des fichiers
              if: steps.check-updates.outputs.updates == 'true'
              run: |
                  # Restaurer skip-worktree pour les fichiers protÃ©gÃ©s
                  git update-index --skip-worktree src/components/VencordSettings/BackupAndRestoreTab.tsx || true
                  git update-index --skip-worktree src/components/VencordSettings/VencordTab.tsx || true
                  git update-index --skip-worktree src/equicordplugins/clientSideBlock/index.tsx || true
                  git update-index --skip-worktree src/equicordplugins/followVoiceUser/index.tsx || true
                  git update-index --skip-worktree src/equicordplugins/moreStickers/index.tsx || true
                  git update-index --skip-worktree src/main/patcher.ts || true
                  git update-index --skip-worktree src/plugins/_core/settings.tsx || true
                  git update-index --skip-worktree src/utils/settingsSync.ts || true

            - name: ðŸ”„ Merge upstream/main
              if: steps.check-updates.outputs.updates == 'true'
              run: |
                  git merge upstream/main --no-edit --strategy-option=ours || {
                    echo "âŒ Conflit dÃ©tectÃ©, rÃ©solution automatique..."
                    git checkout --ours .
                    git add .
                    git commit -m "ðŸ”„ Auto-merge Equicord updates (conflicts resolved)" || true
                  }

            - name: ðŸ›¡ï¸ VÃ©rifier protection des fichiers
              if: steps.check-updates.outputs.updates == 'true'
              run: |
                  echo "ðŸ“‹ Fichiers protÃ©gÃ©s:"
                  git ls-files -v | grep ^S || echo "âš ï¸  Aucun fichier protÃ©gÃ© trouvÃ©"

            - name: ðŸš€ Push vers Bashcord
              if: steps.check-updates.outputs.updates == 'true'
              run: |
                  git push origin main
                  echo "âœ… Bashcord mis Ã  jour avec les derniÃ¨res modifications d'Equicord!"

            - name: ðŸ“ CrÃ©er rÃ©sumÃ©
              if: steps.check-updates.outputs.updates == 'true'
              run: |
                  echo "## ðŸŽ‰ Bashcord mis Ã  jour automatiquement!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Nouvelles modifications intÃ©grÃ©es:" >> $GITHUB_STEP_SUMMARY
                  git log --oneline HEAD~10..HEAD >> $GITHUB_STEP_SUMMARY || true
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### âœ… Fichiers Bashcord protÃ©gÃ©s:" >> $GITHUB_STEP_SUMMARY
                  echo "- Plugin noLeak" >> $GITHUB_STEP_SUMMARY
                  echo "- Tous vos userplugins" >> $GITHUB_STEP_SUMMARY
                  echo "- Modifications core Bashcord" >> $GITHUB_STEP_SUMMARY
